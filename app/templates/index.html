{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}TestApp{% endblock %}

{% block page_content %}
<div class="page-header">
    <h1 align="center">Test Failed Records</h1>
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Edit Record</h4>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label for="case_modal" class="col-form-label">Case:</label>
                            <input type="hidden" id="id_modal" name="id_modal">
                            <input type="text" readonly class="form-control" id="case_modal">
                        </div>
                        <div class="mb-3">
                            <label for="category_modal" class="col-form-label">Category:</label>
                            <input type="text" class="form-control" id="category_modal">
                        </div>
                        <div class="mb-3">
                            <label for="nvbug_modal" class="col-form-label">NvBug:</label>
                            <input type="text" class="form-control" id="nvbug_modal">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <submit type="button" class="btn btn-success" id="editButton">Save</submit>
                </div>
            </div>
        </div>
    </div>
    <div class="form-group form-inline">
        <select data-live-search="true" id="version" class="form-control form-select" title="Version">
            {% for row in version_list %}
            <option value="{{ row }}" {% if row == selected_version %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="trt" class="form-control form-select" title="TensorRT">
            <option value="">ALL</option>
            {% for row in trt_list %}
            <option value="{{ row }}" {% if row == selected_trt %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="cuda" class="form-control form-select" title="CUDA">
            <option value="">ALL</option>
            {% for row in cuda_list %}
            <option value="{{ row }}" {% if row == selected_cuda %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="gpu" class="form-control form-select" title="GPU">
            <option value="">ALL</option>
            {% for row in gpu_list %}
            <option value="{{ row }}" {% if row == selected_gpu %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="os" class="form-control form-select" title="OS">
            <option value="">ALL</option>
            {% for row in os_list %}
            <option value="{{ row }}" {% if row == selected_os %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="arch" class="form-control form-select" title="Arch">
            <option value="">ALL</option>
            {% for row in arch_list %}
            <option value="{{ row }}" {% if row == selected_arch %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="category" class="form-control form-select" title="Category">
            <option value="">ALL</option>
            {% for row in category_list %}
            <option value="{{ row }}" {% if row == selected_category %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
        <select data-live-search="true" id="case_name" class="form-control form-select" title="Case">
            <option value="">ALL</option>
            {% for row in case_list %}
            <option value="{{ row }}" {% if row == selected_case %} selected {% endif %}>{{ row }}</option>
            {% endfor %}
        </select>
    </div>
    <div>
        <table class="table table-striped table-hover" style="word-break:break-all">
            <thead>
                <tr>
                    <!-- <th scope="col">#</th> -->
                    <th scope="col" width="200px">Job</th>
                    <th scope="col" width="250px">Case Name</th>
                    <th scope="col">TensorRT</th>
                    <th scope="col">Driver</th>
                    <th scope="col">CUDA</th>
                    <th scope="col">CUDNN</th>
                    <th scope="col">GPU</th>
                    <th scope="col">OS</th>
                    <th scope="col">Arch</th>
                    <th scope="col">Category</th>
                    <th scope="col">NvBug</th>
                    <th scope="col">Edit</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td scope="row" hidden="hidden">{{ row.id }}</td>
                    <td>{{ row.job }}</td>
                    <td><a href="{{ row.url }}">{{ row.case_name }}</a></td>
                    <td>{{ row.trt }}</td>
                    <td>{{ row.driver }}</td>
                    <td>{{ row.cuda }}</td>
                    <td>{{ row.cudnn }}</td>
                    <td>{{ row.platform }}</td>
                    <td>{{ row.os }}</td>
                    <td>{{ row.arch }}</td>
                    <td>{{ row.category }}</td>
                    <td>{{ row.nvbug }}</td>
                    <td>
                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#editModal">
                            Edit
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% if pagination %}
<div class="pagination" id="page" name="page">
    {{ pagination.links }}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function () {
        $(document).on('click', "#editButton", function (event) {
            event.preventDefault();
            var case_id = $("#id_modal").val()
            var category = $("#category_modal").val()
            var nvbug = $("#nvbug_modal").val()
            // or call the save function here
            edit(case_id, category, nvbug);
            $(this).prev().click();
            history.go(0);
        });

        $(document).on('show.bs.modal', '#editModal', function () {
            $tr = $(event.target).closest('tr');
            var data = $tr.children("td").map(function () {
                return $(this).text();
            }).get();

            $('#id_modal').val(data[0]);
            $('#case_modal').val(data[2]);
            $('#category_modal').val(data[10]);
            $('#nvbug_modal').val(data[11]);
        });

        $("#version").selectpicker();
        $("#trt").selectpicker();
        $("#cuda").selectpicker();
        $("#gpu").selectpicker();
        $("#os").selectpicker();
        $("#arch").selectpicker();
        $("#category").selectpicker();
        $("#case_name").selectpicker();

        function edit(id, category, nvbug) {
            $.ajax({
                url: "/edit",
                method: "POST",
                data: { 
                    id: id,
                    category: category,
                    nvbug: nvbug
                },
                dataType: "json",
                success: function (data) {
                }
            });
        }

        function filter_data() {
            var version = $("#version").val()
            var trt = $("#trt").val()
            var cuda = $("#cuda").val()
            var gpu = $("#gpu").val()
            var os = $("#os").val()
            var arch = $("#arch").val()
            var category = $("#category").val()
            var case_name = $("#case_name").val()

            window.location = '?version=' + version +
                              '&&' + 'tensorrt=' + trt +
                              '&&' + 'cuda=' + cuda +
                              '&&' + 'gpu=' + gpu +
                              '&&' + 'os=' + os +
                              '&&' + 'arch=' + arch +
                              '&&' + 'category=' + category +
                              '&&' + 'case_name=' + case_name;

        }

        $(document).on("change", "#version", function () {
            filter_data();
        });

        $(document).on("change", "#trt", function () {
            filter_data();
        });

        $(document).on("change", "#cuda", function () {
            filter_data();
        });

        $(document).on("change", "#gpu", function () {
            filter_data();
        });

        $(document).on("change", "#os", function () {
            filter_data();
        });

        $(document).on("change", "#arch", function () {
            filter_data();
        });

        $(document).on("change", "#category", function () {
            filter_data();
        });

        $(document).on("change", "#case_name", function () {
            filter_data();
        });
    });
</script>
{% endblock %}